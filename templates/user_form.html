{% extends "base.html" %}

{% block content %}

<style>
    /* Цвета для групп */
    .bg-purple { background-color: #6f42c1 !important; color: white; }
    .bg-indigo { background-color: #6610f2 !important; color: white; }
    .bg-pink   { background-color: #d63384 !important; color: white; }
    .bg-orange { background-color: #fd7e14 !important; color: white; }
    .bg-cyan   { background-color: #0dcaf0 !important; color: black; }
    .bg-azure  { background-color: #0d6efd !important; color: white; }
    .bg-primary { background-color: #0d6efd !important; color: white; }
    .bg-success { background-color: #198754 !important; color: white; }
    .bg-secondary { background-color: #6c757d !important; color: white; }
    .bg-alpha  { background-color: #0dcaf0 !important; color: black; font-weight: bold; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white">Пользователь: <span class="text-purple">{{ row.username }}</span></h2>
    <a href="/admin/users" class="btn btn-outline-light btn-sm">Назад к списку</a>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card-dark mb-4">
            <h4 class="mb-3 text-white">Основные настройки</h4>
            <form method="post" action="/admin/users/edit/{{ row.uid }}">
                <div class="mb-3">
                  <label class="form-label text-muted">UID</label>
                  <input type="text" class="form-control bg-dark text-muted border-secondary" value="{{ row.uid }}" readonly disabled style="font-size: 0.8rem;">
                </div>

                <div class="mb-3">
                  <label class="form-label text-muted">Email</label>
                  <input type="text" class="form-control bg-dark text-white border-secondary" value="{{ row.email }}" readonly disabled>
                </div>
                
                <div class="mb-3 form-check">
                    <input class="form-check-input" type="checkbox" value="true" id="email_confirmed" name="email_confirmed" 
                           {% if row.email_confirmed %}checked{% endif %}>
                    <label class="form-check-label text-white" for="email_confirmed">Email подтвержден</label>
                </div>

                <hr class="border-secondary">
                
                <div class="mb-3">
                    <label class="form-label text-warning">Смена пароля</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" name="new_password" placeholder="Новый пароль...">
                </div>

                <button type="submit" class="btn btn-purple w-100">Сохранить настройки</button>
            </form>
        </div>
        
        <div class="text-center mt-2">
             <a href="/admin/users/delete/{{ row.uid }}" class="text-danger small" onclick="return confirm('Удалить пользователя навсегда?')">Удалить пользователя</a>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card-dark mb-4 border border-info">
            <h4 class="mb-3 text-info">Активные подписки</h4>
            
            {% if user_groups %}
            <div class="table-responsive">
                <table class="table table-dark table-sm table-bordered border-secondary mb-3 align-middle">
                    <thead>
                        <tr>
                            <th>Группа</th>
                            <th>Истекает</th>
                            <th class="text-center">Действие</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ug in user_groups %}
                        {% set badge_color = group_colors.get(ug.slug, 'secondary') %}
                        <tr>
                            <td>
                                <span class="badge bg-{{ badge_color }} fs-6">{{ ug.name }}</span>
                            </td>
                            <td>
                                {% if ug.expires_at and ug.expires_at.year > 2090 %}
                                    <span class="text-success fw-bold">Навсегда</span>
                                {% else %}
                                    {{ ug.expires_at.strftime('%d.%m.%Y') if ug.expires_at else 'Вечно' }}
                                    {% if ug.expires_at and ug.expires_at < now %}
                                        <span class="text-danger small">(Истекла)</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <form action="/admin/users/revoke_group" method="post" style="display:inline;" onsubmit="return confirm('Удалить привязку к группе {{ ug.name }}?');">
                                    <input type="hidden" name="user_uid" value="{{ row.uid }}">
                                    <input type="hidden" name="group_id" value="{{ ug.id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-2">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-secondary py-2 small mb-3">Нет активных групп.</div>
            {% endif %}

            <form action="/admin/users/assign_group" method="POST" class="bg-dark p-3 rounded border border-secondary">
                <h6 class="text-white mb-2">Выдать новую группу</h6>
                <input type="hidden" name="user_uid" value="{{ row.uid }}">
                
                <div class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label text-muted small mb-0">Выберите группу</label>
                        <select name="group_id" class="form-select form-select-sm bg-dark text-white border-secondary" id="groupSelect" required onchange="checkGroupType()">
                            {% for g in all_groups %}
                                <option value="{{ g.id }}" data-slug="{{ g.slug }}">
                                    {{ g.name }} (Lvl: {{ g.access_level }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3" id="daysContainer">
                        <label class="form-label text-muted small mb-0">Дней</label>
                        <input type="number" name="duration_days" id="daysInput" class="form-control form-control-sm bg-dark text-white border-secondary" value="30">
                    </div>

                    <div class="col-md-4">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="is_forever" id="isForever" value="true" onchange="toggleDaysInput()">
                            <label class="form-check-label text-white small" for="isForever">Навсегда</label>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm w-100">Добавить / Обновить</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="card-dark">
            <h4 class="mb-3 text-white">История транзакций</h4>
            {% if purchases %}
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-dark table-sm table-hover mb-0" style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Товар / Действие</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in purchases %}
                            <tr>
                                <td>{{ p.created_at.strftime("%d.%m.%Y") }}</td>
                                <td>{{ p.plan }}</td>
                                <td class="text-success">{{ p.amount }} {{ p.currency }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted text-center py-2 small">История пуста.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function checkGroupType() {
        const select = document.getElementById('groupSelect');
        if (!select || select.selectedIndex < 0) return;

        const selectedOption = select.options[select.selectedIndex];
        const slug = selectedOption.getAttribute('data-slug');
        const isForeverCheckbox = document.getElementById('isForever');
        
        const foreverGroups = ['tech-admin', 'admin', 'senior-staff', 'staff', 'media', 'moderator'];
        
        if (foreverGroups.includes(slug)) {
            isForeverCheckbox.checked = true;
        } else {
            isForeverCheckbox.checked = false;
        }
        toggleDaysInput();
    }

    function toggleDaysInput() {
        const isForever = document.getElementById('isForever').checked;
        const daysContainer = document.getElementById('daysContainer');
        const daysInput = document.getElementById('daysInput');
        
        if (isForever) {
            daysContainer.style.opacity = '0.3';
            daysInput.disabled = true; 
        } else {
            daysContainer.style.opacity = '1';
            daysInput.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', checkGroupType);
</script>
{% endblock %}
